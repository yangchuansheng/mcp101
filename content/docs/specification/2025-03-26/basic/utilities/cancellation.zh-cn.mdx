---
title: 请求取消
---

<Callout type="info">
**协议版本**: 2025-03-26
</Callout>

模型上下文协议（MCP）支持通过通知消息来（可选地）取消正在进行中的请求。
通信的任何一方都可以发送取消通知，以表明先前发出的某个请求应被终止。

## 取消流程

当一方希望取消一个正在进行中的请求时，它会发送一个 `notifications/cancelled` 通知，其中包含：

- 需要取消的请求的 ID
- 一个可选的原因字符串，可用于日志记录或向用户显示

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/cancelled",
  "params": {
    "requestId": "123",
    "reason": "用户请求取消"
  }
}
```

## 行为要求

1.  取消通知 **必须** 仅引用满足以下条件的请求：
    *   先前由发送取消通知的这一方发出的
    *   且据信仍在进行中的
2.  客户端 **不得** 取消 `initialize` 初始化请求。
3.  收到取消通知的一方 **应当**：
    *   停止处理被取消的请求
    *   释放相关联的资源
    *   不为已被取消的请求发送响应
4.  在以下情况下，接收方 **可以** 忽略取消通知：
    *   通知中引用的请求 ID 未知
    *   该请求的处理已经完成
    *   该请求本身无法被取消
5.  发送取消通知的一方 **应当** 忽略之后可能收到的、针对该已取消请求的任何响应。

## 时序考量

由于网络延迟，取消通知可能会在请求处理完成之后才到达，甚至可能在响应已经发送之后。

双方 **必须** 能够优雅地处理这些竞态条件：

<Mermaid chart={`
sequenceDiagram
   participant 客户端
   participant 服务端

   客户端->>服务端: 请求 (ID: 123)
   Note over 服务端: 开始处理
   客户端--)服务端: notifications/cancelled (ID: 123)
   alt
      Note over 服务端: 处理可能在<br/>取消通知到达前<br/>已完成
   else 若未完成
      Note over 服务端: 停止处理
   end
`} />

## 实现说明

-   双方 **应当** 记录取消原因，以便于调试。
-   应用程序的用户界面 **应当** 在请求被取消时向用户提供明确的指示。

## 错误处理

无效的取消通知 **应当** 被忽略，例如：

-   包含未知的请求 ID
-   针对已经完成的请求
-   通知格式错误

这种处理方式维持了通知“即发即弃”（fire and forget）的特性，同时也考虑并允许了异步通信中可能出现的竞态条件。
